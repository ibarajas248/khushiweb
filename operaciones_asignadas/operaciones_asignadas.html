<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Tareas Asignadas</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@300;400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/bootstrap.css">
  <link rel="stylesheet" href="assets/vendors/perfect-scrollbar/perfect-scrollbar.css">
  <link rel="stylesheet" href="assets/vendors/bootstrap-icons/bootstrap-icons.css">
  <link rel="stylesheet" href="assets/css/app.css">
  <link rel="shortcut icon" href="assets/images/favicon.svg" type="image/x-icon">

  <style>
    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
    }

    body {
      display: flex;
      flex-direction: column;
    }

    #contenido {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    .sidebar {
      height: 100vh;
      overflow-y: auto;
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      width: 240px;
      background-color: #f8f9fa;
      z-index: 1030;
      border-right: 1px solid #dee2e6;
      padding: 1rem;
    }

    .contenido-scroll {
      margin-left: 240px;
      height: 100vh;
      overflow-y: auto;
      padding: 2rem;
      flex-grow: 1;
    }

    .tarjeta {
      display: none;
      border: 1px solid #dee2e6;
      padding: 1.5rem;
      border-radius: 0.5rem;
      margin-top: 1.5rem;
      background-color: #f8f9fa;
    }
  </style>
</head>
<body>

  <!-- Menú móvil -->
  <nav class="navbar navbar-dark bg-dark sticky-top d-md-none">
    <div class="container-fluid">
      <button class="btn btn-outline-light" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileMenu" aria-controls="mobileMenu">
        <i class="bi bi-list"></i>
      </button>
      <span class="navbar-brand ms-2">Khushi confecciones</span>
    </div>
  </nav>

  <div class="offcanvas offcanvas-start d-md-none" tabindex="-1" id="mobileMenu" aria-labelledby="mobileMenuLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="mobileMenuLabel">Menú</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body">
      <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link active" href="#"><i class="bi bi-house-fill"></i> Dashboard</a></li>
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-file-earmark"></i> Orders</a></li>
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-cart"></i> Products</a></li>
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-people"></i> Customers</a></li>
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-graph-up"></i> Reports</a></li>
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-puzzle"></i> Integrations</a></li>
      </ul>
      <hr>
      <h6 class="text-muted text-uppercase">Saved reports</h6>
      <ul class="nav flex-column mb-auto">
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-file-earmark-text"></i> Current month</a></li>
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-file-earmark-text"></i> Last quarter</a></li>
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-file-earmark-text"></i> Social engagement</a></li>
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-file-earmark-text"></i> Year-end sale</a></li>
      </ul>
      <hr>
      <ul class="nav flex-column mb-auto">
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-gear-wide-connected"></i> Settings</a></li>
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-door-closed"></i> Sign out</a></li>
      </ul>
    </div>
  </div>

  <!-- Contenido general -->
  <div id="contenido">

    <!-- Sidebar fijo -->
    <nav class="sidebar d-none d-md-block">
      <ul class="nav flex-column">
        <li class="nav-item"><a class="nav-link active" href="../index.html"><i class="bi bi-house-fill"></i> Inicio</a></li>
        <li class="nav-item"><a class="nav-link" href="../productos/productosBootstrap.html"><i class="bi bi-file-earmark"></i> Productos</a></li>
        <li class="nav-item"><a class="nav-link" href="../OC/OC.html"><i class="bi bi-cart"></i> Orden de compra</a></li>
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-people"></i> Operaciones asignadas</a></li>
        <li class="nav-item"><a class="nav-link" href="../Produccion/produccion.html"><i class="bi bi-people"></i> Operaciones completadas</a></li>
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-graph-up"></i> Seguimiento</a></li>
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-puzzle"></i> Perfil</a></li>
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-puzzle"></i> Tiempos</a></li>
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-puzzle"></i> Insumos</a></li>
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-puzzle"></i> Distribución de insumos</a></li>
      </ul>
      <hr>
      <h6 class="text-muted text-uppercase">Saved reports</h6>
      <ul class="nav flex-column mb-auto">
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-file-earmark-text"></i> Current month</a></li>
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-file-earmark-text"></i> Last quarter</a></li>
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-file-earmark-text"></i> Social engagement</a></li>
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-file-earmark-text"></i> Year-end sale</a></li>
      </ul>
      <hr>
      <ul class="nav flex-column mb-auto">
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-gear-wide-connected"></i> Ajustes</a></li>
        <li class="nav-item"><a class="nav-link" href="#"><i class="bi bi-door-closed"></i> Cerrar sesión</a></li>
      </ul>
    </nav>

    <!-- Contenido con scroll -->
    <main class="contenido-scroll">
      <h2 class="mb-4 text-primary">Tareas Asignadas</h2>
      <div id="mensaje-error" class="text-danger mb-3"></div>

      <div class="table-responsive">
        <table class="table table-bordered table-hover table-sm align-middle">
          <thead class="table-light">
            <tr>
              <th>Producto</th>
              <th>Subparte</th>
              <th>Operaciones</th>
              <th>ID Lote</th>
              <th>Cantidad</th>
              <th>Empleado</th>
              <th>Nombre</th>
              <th>Apellidos</th>
              <th>Lote</th>
              <th>Completado</th>
              <th>Habilitado</th>
              <th>Fecha</th>
            </tr>
          </thead>
          <tbody id="tabla-tareas"></tbody>
        </table>
      </div>

      <div class="tarjeta shadow-sm" id="tarjetaDetalle">
        <h5 class="mb-3 text-secondary">Detalle de la operación</h5>
        <div class="row">
          <div class="col-md-6">
            <p><strong>Producto:</strong> <span id="detalleProducto"></span></p>
            <p><strong>Subparte:</strong> <span id="detalleSubparte"></span></p>
            <p><strong>Operaciones:</strong> <span id="detalleOperaciones"></span></p>
            <p><strong>Cantidad:</strong> <span id="detalleCantidad"></span></p>
          </div>
          <div class="col-md-6">
            <p><strong>Nombre:</strong> <span id="detalleNombre"></span></p>
            <p><strong>Apellidos:</strong> <span id="detalleApellidos"></span></p>
            <p><strong>Habilitado:</strong> <span id="detalleHabilitado"></span></p>
          </div>
        </div>
        <button class="btn btn-secondary mt-3" onclick="cerrarDetalle()">Cerrar</button>
      </div>
    </main>
  </div>

  <!-- JS -->
  <script>
    let habilitados = [];

    document.addEventListener("DOMContentLoaded", () => {
      cargarTareas(1);
    });

    function cargarTareas(idEmpresa) {
      const url = `https://khushiconfecciones.com/app_khushi/consultas_lotes/buscar_todas_tareas_asignadas.php?id_empresa=${idEmpresa}`;

      document.getElementById("mensaje-error").textContent = "Cargando...";

      fetch(url)
        .then(res => res.json())
        .then(data => {
          const tbody = document.getElementById("tabla-tareas");
          tbody.innerHTML = "";
          document.getElementById("mensaje-error").textContent = "";

          habilitados = [];

          data.forEach(item => {
            let empleado = item.empleado?.trim() || "no asignado";

            if (item.habilitado === "si" && item.completado === "no") {
              habilitados.push(empleado);
            }

            const fila = document.createElement("tr");
            fila.innerHTML = `
              <td>${item.producto}</td>
              <td>${item.subparte}</td>
              <td>${item.operaciones}</td>
              <td>${item.id_lotes_operaciones}</td>
              <td>${item.cantidad}</td>
              <td>${empleado}</td>
              <td>${item.nombre}</td>
              <td>${item.Apellidos}</td>
              <td>${item.lote}</td>
              <td>${item.completado}</td>
              <td>${item.habilitado}</td>
              <td>${item.fecha}</td>
            `;

            fila.addEventListener("contextmenu", (e) => {
              e.preventDefault();
              mostrarDetalle(item);
            });

            tbody.appendChild(fila);
          });
        })
        .catch(error => {
          console.error("Error:", error);
          document.getElementById("mensaje-error").textContent = "Error de conexión.";
        });
    }

    function mostrarDetalle(item) {
      document.getElementById("detalleProducto").textContent = item.producto;
      document.getElementById("detalleSubparte").textContent = item.subparte;
      document.getElementById("detalleOperaciones").textContent = item.operaciones;
      document.getElementById("detalleCantidad").textContent = item.cantidad;
      document.getElementById("detalleNombre").textContent = item.nombre;
      document.getElementById("detalleApellidos").textContent = item.Apellidos;
      document.getElementById("detalleHabilitado").textContent = item.habilitado;

      document.getElementById("tarjetaDetalle").style.display = "block";
    }

    function cerrarDetalle() {
      document.getElementById("tarjetaDetalle").style.display = "none";
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="assets/vendors/perfect-scrollbar/perfect-scrollbar.min.js"></script>
  <script src="assets/js/bootstrap.bundle.min.js"></script>
  <script src="assets/js/main.js"></script>
  <script src="../productos/script_productos.js"></script>

</body>
</html>
